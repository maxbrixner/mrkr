{% extends "base.jinja" %}

{% block nav %}
{% include 'content-nav.jinja' %}
{% endblock %}

{% block main %}
<div class="labeling">
    <div class="page-toolbar labeling">
        <div>
            <button class="secondary" aria-label="Back to Tasks"
                hx-get="{{url_for('tasks_page')}}?id={{task.source.project.id}}" hx-trigger="click"
                hx-swap="outerHTML swap:{{config.swap_delay}}ms" hx-target="#main" hx-select="#main" hx-push-url="true"
                hx-indicator="#main" hx-request='{"timeout": {{config.timeout}}}'><img
                    src="/static/img/arrow-back-outline.svg"></button>
        </div>
        <div>
            <h1>{{task.name}}</h1>
        </div>
        <div>
            <button class="primary" id="save-labels-button" aria-label="Save Changes" form="user-labels">
                <span id="save-labels-span">Save Changes</span>
            </button>
        </div>
    </div>
    <div class="page-surface labeling" id="label-surface">
        <div class="image-container">
            <img id="label-image" src="/label-image/?id={{file.id}}" draggable="false">
            </img>
            {% if ocr %}
            {% for block in ocr.pages[0].blocks %}
            {% if label_associated_with(block.id) %}
            <div class="highlight" data-content="{{block.content}}"
                style="left:{{block.left}}%; top:{{block.top}}%; width:{{block.width}}%; height:{{block.height}}%; background-color: {{label_associated_with(block.id).label_definition.color}};"
                data-content="{{block.content}}" data-id="{{block.id}}" data-active="true">
            </div>
            {% else %}
            <div class="highlight" data-content="{{block.content}}"
                style="left:{{block.left}}%; top:{{block.top}}%; width:{{block.width}}%; height:{{block.height}}%;"
                data-content="{{block.content}}" data-id="{{block.id}}" data-active="false">
            </div>
            {% endif %}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    <div id="labeling-details" class="page-details labeling">
        <div class="available-labels">
            {% for label in task.source.project.labels %}
            <button class="label-button" style="background-color: {{label.color}}20; border-color: {{label.color}};"
                data-id="{{label.id}}" data-label="{{label.name}}" data-color="{{label.color}}">{{label.name}}</button>
            {% endfor %}
        </div>
        <form id="user-labels" class="user-labels" hx-post="{{url_for('save_labels')}}?file_id={{file.id}}"
            hx-indicator="#save-labels-span" hx-target="#save-labels-span"
            hx-swap="innerHTML swap:{{config.swap_delay}}ms">
            {% for label in file.labels %}
            <div class="user-label"
                style="background-color: {{label.label_definition.color}}20; border-color: {{label.label_definition.color}};">
                <span>{{label.label_definition.name}}</span>
                <input type="hidden" class="label-definition-id-input" name="label_definition_id"
                    value="{{label.label_definition.id}}">
                <input type="hidden" class="block-ids-input" name="block_ids"
                    value="{%for association in label.associations%}{{association.block_id}}{%if not loop.last%},{%endif%}{%endfor%}">
                <input type="text" class="user-content-input" name="user_content" value="{{label.user_content}}">
                <button type="button" class="delete-label" aria-label="Delete Label" data-id="98"><img
                        src="/static/img/trash-outline.svg"></button>
            </div>
            {% endfor %}
            <input type="hidden" name="csrf_token" value="{{request.state.csrf_token}}">
            <input type="hidden" name="task_id" value="{{task.id}}">
        </form>
    </div>
    {% endblock %}